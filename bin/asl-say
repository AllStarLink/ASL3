#!/usr/bin/bash
#
# Copyright 2024 AllStarLink Inc., Jason McCormick N8EI
#
# This program is free software: you can redistribute it and/or
# modify it under the terms of the GNU General Public License as published
# by the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
# FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
# See https://www.gnu.org/licenses/gpl-3.0.txt

BI_AUDIO="/usr/share/asterisk/sounds/en"
CU_AUDIO="/var/lib/asterisk/sounds/en"

# date/time (for testing with "-d yyyymmdd" and "-t hhmm"))
ALT_DATE=""
ALT_TIME=""
ALT_DATE_TIME=""

function ast_rx_lp(){
	asterisk -rx "rpt localplay ${NODE} $1" 2>&1
}

function build_and_say(){
	TMPAUD=$(mktemp --suffix=.ulaw)
	chmod 644 ${TMPAUD}
	ASTAUD=$(echo ${TMPAUD} | sed -e 's/\.ulaw//g')
	SIA="-t ul -r 8k -c 1"
	for e in $*
	do
		if [ -f "${CU_AUDIO}/${e}.ulaw" ]; then
			F_IN="${F_IN} ${SIA} ${CU_AUDIO}/${e}.ulaw"
			continue
		fi
		if [ -f "${BI_AUDIO}/${e}.ulaw" ]; then
			F_IN="${F_IN} ${SIA} ${BI_AUDIO}/${e}.ulaw"
			continue
		fi
	done
	sox --combine concatenate -c 1 -r 8k \
		${F_IN} -t ul ${TMPAUD}
	ast_rx_lp ${ASTAUD}
	sleep 10
	rm ${TMPAUD}
}

function get_time(){

	# calculate the hour
	NOW_H=$(date ${ALT_DATE_TIME} +%I | sed -e 's/0//g')
	NOW_H_FULL="digits/${NOW_H}"

	# calculate the minute audio
	NOW_M=$(date ${ALT_DATE_TIME} +%0M | sed -e s/'^0//')
	if (( ${NOW_M} == 0 )); then
		NOW_M_FULL="digits/oclock"
	elif (( ${NOW_M} < 10 )); then
		NOW_M_FULL="digits/oh digits/${NOW_M}"
	elif (( ${NOW_M} < 20 )); then
		NOW_M_FULL="digits/${NOW_M}"
	else
		A=$(( ${NOW_M} / 10 ))
		B=$(( ${NOW_M} % 10 ))
		if (( $B == 0 )); then
			NOW_M_FULL="digits/${A}0"
		else
			NOW_M_FULL="digits/${A}0 digits/${B}"
		fi
	fi

	# am/pm
	NOW_A=$(date ${ALT_DATE_TIME} +%P | sed 's/^\([ap]\)\(m\)/\1-\2/')

	# timezone with letters prefix
	NOW_TZ=$(date ${ALT_DATE_TIME} +%Z | tr '[A-Z]' '[a-z]' | sed 's/./letters\/& /g')

	echo "rpt/thetimeis ${NOW_H_FULL} ${NOW_M_FULL} digits/${NOW_A} ${NOW_TZ}"
}

function get_time24(){

	# calculate the hour audio
	NOW_H=$(date ${ALT_DATE_TIME} +%-H)
	if (( ${NOW_H} < 20 )); then
		NOW_H_FULL="digits/${NOW_H} hours"
	else
		A=$(( ${NOW_H} / 10 ))
		B=$(( ${NOW_H} % 10 ))
		if (( $B == 0 )); then
			NOW_H_FULL="digits/${A}0 hours"
		else
			NOW_H_FULL="digits/${A}0 digits/${B} hours"
		fi
	fi

	# calculate the minute audio
	NOW_M=$(date ${ALT_DATE_TIME} +%0M | sed -e s/'^0//')
	if (( ${NOW_M} < 20 )); then
		NOW_M_FULL="digits/${NOW_M} minutes"
	else
		A=$(( ${NOW_M} / 10 ))
		B=$(( ${NOW_M} % 10 ))
		if (( $B == 0 )); then
			NOW_M_FULL="digits/${A}0 minutes"
		else
			NOW_M_FULL="digits/${A}0 digits/${B} minutes"
		fi
	fi

	# timezone with letters prefix
	NOW_TZ=$(date ${ALT_DATE_TIME} +%Z | tr '[A-Z]' '[a-z]' | sed 's/./letters\/& /g')

	echo "rpt/thetimeis ${NOW_H_FULL} ${NOW_M_FULL} ${NOW_TZ}"
}

function get_ip4(){
	IP=$(ip -4 -o a | cut -d ' ' -f 2,7 | cut -d '/' -f 1 |\
		grep -v 127.0. | awk '{print $2}')
	for e in $(echo ${IP} | sed 's/./& /g')
	do
		case $e in
			.)	IP_SAY="${IP_SAY} letters/dot" ;;
			*)	IP_SAY="${IP_SAY} digits/$e" ;;
		esac
	done
	echo "letters/i letters/p ${IP_SAY}"
}

function get_ip6(){
	IP=$(ip -6 addr | grep inet6 | awk -F '[ \t]+|/' '{print $3}' |\
		 grep -v ^::1 | grep -v ^fe80)
	for e in $(echo ${IP} | sed 's/./& /g')
	do
		case $e in
			:)  IP_SAY="${IP_SAY} letters/dot" ;;
			[abcdef])  IP_SAY="${IP_SAY} letters/$e" ;;
			*)  IP_SAY="${IP_SAY} digits/$e" ;;
		esac
	done
	echo "letters/i letters/p digits/6 ${IP_SAY}"
}

function usage(){
	echo "Usage: $0 -n {NODE} -w ( time | time24 | ip4 | ip6 )" 1>&2
	exit 1
}

while getopts "n:w:d:t:" opt; do
	case ${opt} in
		n)	NODE="${OPTARG}" ;;
		w)	WHAT="${OPTARG}" ;;
		d)	ALT_DATE="${OPTARG}" ;;
		t)	ALT_TIME="${OPTARG}" ;;
		*)	usage ;;
	esac
done
shift $((OPTIND-1))

if [ -z "${NODE}" ] || [ ${NODE} -lt 1 ]; then
	echo "-n {NODE} must be a number greater than 0" 1>&2
	exit
fi

if [ -n "${ALT_DATE}${ALT_TIME}" ]; then
	if [ -n "${ALT_DATE}" ]; then
		re=^[0-9]{8}$
		if ! [[ ${ALT_DATE} =~ $re ]]; then
			echo "Alternate date must be YYYYMMDD"
			exit 1
		fi
	else
		ALT_DATE=$(date +%Y%m%d)
	fi
	if [ -n "${ALT_TIME}" ]; then
		re=^[0-9]{4}$
		if ! [[ ${ALT_TIME} =~ $re ]]; then
			echo "Alternate time must be HHMM"
			exit 1
		fi
	else
		ALT_TIME=$(date +%H%M)
	fi
	touch -t "${ALT_DATE}${ALT_TIME}" /tmp/asl-say-date-reference
	ALT_DATE_TIME="-r /tmp/asl-say-date-reference"
fi

case ${WHAT} in
	time)		build_and_say $(get_time) ;;
	time24)		build_and_say $(get_time24) ;;
	ip | ip4) 	build_and_say $(get_ip4) ;;
	ip6)		build_and_say $(get_ip6) ;;
	*) 			usage ;;
esac

exit 0

